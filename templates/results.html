$def with (context)

<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">WhatsApp Chat Analyzer</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a></li>
        <li><a href="#">About</a></li>
        <li><a href="/upload">Analyse</a></li>
      </ul>
    </div><!--/.navbar-collapse -->
  </div>
</nav>

<div class="container main-content">
  <div class="row">

    <div class="col-xs-12">
      <div class="page-header">
        <h1>Analysis Results</h1>
      </div>

      <h4>Participants</h4>
      $for name in context.users:
          <span class="label label-primary">$name</span>
      
      <h4>Number of Messages</h4> 
        $context.num_messages

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Overview</h3>
        </div>
        <div class="panel-body">
          <table class="table table-striped">
            <tbody>
              <tr><td>In total, the <strong>$len(context.users)</strong> people in this chat sent <strong>$context.num_messages</strong> messages over <strong>$context.overview['num_days']</strong> days. </td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="row">
        
        <div class="col-xs-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Who's the biggest spammer?</h3>
            </div>
            <div class="panel-body">
              <div id="biggestSpammerSvg"></div>
            </div>
            <div class="panel-footer hidden" id="biggestSpammerRes"></div>
          </div>
        </div>
        
        <div class="col-xs-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Who's getting the biggest slice?</h3>
            </div>
            <div class="panel-body">
              <div id="biggestSliceSvg"></div>
            </div>
            <div class="panel-footer hidden" id="biggestSliceRes"></div>
          </div>
        </div>
      
      </div>
      

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Distribution Over Time</h3>
        </div>
        <div class="panel-body">
          <div id="distributionOverTimeSvg"></div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Calendar View</h3>
        </div>
        <div class="panel-body">
          <div id="calendarViewSvg"></div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Word Cloud</h3>
        </div>
        <div class="panel-body">
          <div id="wordCloudSvg"></div>
        </div>
      </div>

      <div class="row">
        <div class="col-xs-6">

          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Most Popular Words</h3>
            </div>
            <div class="panel-body">
              <table class="table table-striped table-condensed">
                <thead>
                  <tr>
                    <th>Pos.</th>
                    <th>Word</th>
                    <th>Count</th>
                  </tr>
                </thead>
                <tbody id="mostPopularWords"></tbody>
              </table>

            </div>
          </div>

        </div>

        <div class="col-xs-6">
          
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Least Popular Words</h3>
            </div>
            <div class="panel-body">
              <table class="table table-striped table-condensed">
                <thead>
                  <tr>
                    <th>Pos.</th>
                    <th>Word</th>
                    <th>Count</th>
                  </tr>
                </thead>
                <tbody id="leastPopularWords"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
      
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">What were the busiest days?</h3>
        </div>
        <div class="panel-body">
          <div id="stackedAreaSvg">
            <button id="stackedAreaResetBrush" class="btn btn-default">Reset</button>
          </div>
        </div>
      </div>

    </div> <!-- /col-sm-12 -->

  </div>
</div>


<hr>

<div class="container">
  <footer>
    <p>TU Delft - Data Visualization 2014/2015</p>
  </footer>
</div>

<div class="hidden" id="overviewData"></div>
<div class="hidden" id="daysByUser">$context.overview['days_by_user']</div>
<div class="hidden" id="biggestSpammerData">$context.messages_by_user</div>
<div class="hidden" id="messagesByDay">$context.overview['days']</div>
<div class="hidden" id="wordHistogram">$context.overview['word_hist']</div>

<script type="text/javascript">
  $$(document).ready(function() {
    buildBiggestSpammerGraph();
    buildBiggestSliceGraph();
    buildDistributionOverTimeGraph();
    buildWordCloud();
    buildAreaGraph();

    // setTimeout(buildDistributionOverTimeGraph(), 5000);
    // // setTimeout(buildCalendarVierGraph(), 10000);
    // setTimeout(buildWordCloud(), 8000);
  });

  var defaultConfig = {
    smallGraphHeight: 260,
    smallGraphWidth: 500,
    mediumGraphWidth: 660,
    mediumGraphHeight: 320,
    largeGraphWidth: 1138,
    largeGraphHeight: 400
  }


  function buildAreaGraph() {
    var conf = getSvgConf(defaultConfig.largeGraphWidth, defaultConfig.mediumGraphHeight, 20, 40, 80, 40);
    var conf2 = getSvgConf(defaultConfig.largeGraphWidth, defaultConfig.smallGraphHeight / 3, 30, 40, 20, 40)

    var parseDate = d3.time.format("%Y-%m-%d").parse,
      formatDate = d3.time.format("%Y");

    var color = getColorScale();

    var data = JSON.parse(document.getElementById('messagesByDay').innerHTML);
    _.each(data, function (d) {
      d.date = parseDate(d.date);
    });

    var minDate = data[0].date;
    var maxDate = data[data.length - 1].date;

    var x = d3.time.scale()
      .range([0, conf.width])
      .domain(d3.extent(data, function (d) { return d.date; }));

    var y = d3.scale.linear()
      .range([conf.height, 0])
      .domain([0, d3.max(data, function (d) { return d.num_messages; })]);

    var x2 = d3.time.scale()
      .range([0, conf.width])
      .domain(x.domain());

    var y2 = d3.scale.linear()
      .range([conf2.height, 0])
      .domain(y.domain());

    var xAxis = getSimpleAxis(x, "bottom")
      // .tickSize(-conf.height, 0)
      .tickPadding(6);

    var xAxis2 = getSimpleAxis(x2, "bottom")
      .tickPadding(6);

    var yAxis = getSimpleAxis(y, "left")
      // .tickSize(-conf.width)
      .tickPadding(6);

    var zoom = d3.behavior.zoom()
      .x(x)
      .on('zoom', zoomed);

    var brush = d3.svg.brush()
      .x(x2)
      .on("brush", brush);

    var area = d3.svg.area()
      .interpolate("step-after")  // can also be linear or step-after
      .x(function (d) { return x(d.date); })
      .y0(conf.height)  // or y(0)
      .y1(function (d) { return y(d.num_messages); });

    var area2 = d3.svg.area()
      .interpolate("step-after")  // can also be linear or step-after
      .x(function (d) { return x2(d.date); })
      .y0(conf2.height)
      .y1(function (d) { return y2(d.num_messages); });

    var svg = d3.select("#stackedAreaSvg").append("svg")
      .attr("width", conf.width + conf.margin.left + conf.margin.right)
      .attr("height", conf.height + conf.margin.top  + conf2.height + conf.margin.bottom)

    var focus = svg.call(zoom).append("g")
      .attr("transform", "translate(" + (conf.margin.left + 20) + "," + conf.margin.top + ")");

    var context = svg.append("g")
      .attr("transform", "translate(" + (conf2.margin.left + 20) + "," + (conf.height + 60) + ")");

    focus.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + conf.height + ")")
      .call(xAxis);

    focus.append("g")
        .attr("class", "y axis")
        .call(yAxis)
      .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .style("font-size", "10px")
        .text("# Messages");

    var plotArea = focus.append('g')
      .attr('clip-path', 'url(#plotAreaClip)');

    plotArea.append('clipPath')
      .attr('id', 'plotAreaClip')
      .append('rect')
      .attr({ width: conf.width, height: conf.height });

    plotArea.append("path")
      .datum(data)
      .attr("class", "area")
      .attr("d", area);

    context.append("path")
      .datum(data)
      .attr("class", "overview-area")
      .attr("d", area2);

    context.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0, " + conf2.height + ")")
      .call(xAxis2);

    context.append("g")
        .attr("class", "x brush")
        .call(brush)
      .selectAll("rect")
        .attr("y", -6)
        .attr("height", conf.height + 7);


    function zoomed () {
        // console.log(d3.event.translate);
        // console.log(d3.event.scale);

        // focus.select(".x.axis").call(xAxis);
        // focus.select(".y.axis").call(yAxis);
        // focus.select('.area')
        //   .attr("class", "area")
        //   .attr("d", area);
    }

    function brush () {
      x.domain(brush.empty() ? x2.domain() : brush.extent());
      focus.select(".area").attr("class", "area").attr("d", area);
      focus.select(".x.axis").call(xAxis);
    // circlegroup.selectAll(".dot").attr("cx",function(d){ return x(format.parse(d3.keys(d)[0]));}).attr("cy", function(d){ return y(d3.values(d)[0]);});
    };

    document.getElementById("stackedAreaResetBrush").addEventListener("click", function () {
      console.log("DOING THIS");

      brush
        .clear()
        .event(d3.select(".brush"));
    });    

  };


  function buildBiggestSpammerGraph() {
    var conf = getSvgConf(defaultConfig.smallGraphWidth, defaultConfig.smallGraphHeight, 30, 40, 30, 80);
    var format = d3.format(",.0f");

    var x = d3.scale.linear().range([0, conf.width]);
    var y = d3.scale.ordinal().rangeRoundBands([conf.height, 0], .4);
    var xAxis = getSimpleAxis(x, "top").tickSize(-conf.height);
    var yAxis = getSimpleAxis(y, "left").tickSize(0);

    var color = getColorScale();

    var svg = getSvgAddedTo("#biggestSpammerSvg", conf);

    var data = JSON.parse(document.getElementById("biggestSpammerData").innerHTML);

    x.domain([0, d3.max(data, function(d) { return d.num_messages; })]);
    y.domain(data.map(function (d) { return d.name; }));

    var bar = svg.selectAll("g.bar")
      .data(data)
      .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) { return "translate(0," + y(d.name) + ")"; });

    bar.append("rect")
        .attr("width", function(d) { return x(d.num_messages); })
        .style("fill", function(d) { return color(d.name)})
        .attr("height", y.rangeBand());

    bar.append("text")
        .attr("class", "value")
        .attr("x", function(d) { return x(d.num_messages); })
        .attr("y", y.rangeBand() / 2)
        .attr("dx", -3)
        .attr("dy", ".35em")
        .attr("text-anchor", "end")
        .text(function(d) { return format(d.num_messages); });

    svg.append("g")
        .attr("class", "x axis")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

    var biggestSpammer = _.max(data, function (d) { return d.num_messages;});
    $$('#biggestSpammerRes').html(biggestSpammer.name + ' is clearly the biggest spammer with ' + biggestSpammer.num_messages + ' messages sent.').removeClass('hidden');

  };


  function buildBiggestSliceGraph() {
    var width = defaultConfig.smallGraphWidth, height = defaultConfig.smallGraphHeight;
    var conf = getSvgConf(width, height, 30, 40, 30, 100);
    var radius = ( Math.min(conf.width, conf.height) + 20 ) / 2;

    var color = getColorScale();

    var arc = d3.svg.arc()
      .outerRadius(radius - 10)
      .innerRadius(0);

    var pie = d3.layout.pie()
      .sort(null)
      .value(function(d) { return d.num_messages; });

    var svg = d3.select("#biggestSliceSvg").append("svg")
      .attr("width", conf.width + conf.margin.left + conf.margin.right)
      .attr("height", conf.height + conf.margin.top + conf.margin.bottom)
      .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var data = JSON.parse(document.getElementById("biggestSpammerData").innerHTML);

    var g = svg.selectAll(".arc")
      .data(pie(data))
      .enter().append("g")
        .attr("class", "arc");

    g.append("path")
        .attr("d", arc)
        .style("fill", function(d) { return color(d.data.name); });

    g.append("text")
        .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
        .attr("dy", ".35em")
        .style("text-anchor", "middle")
        .text(function(d) { return d.data.name; });

    var biggestSpammer = _.max(data, function (d) { return d.num_messages;});
    $$('#biggestSliceRes').html(biggestSpammer.name + ' has the biggest slice with ' + ((biggestSpammer.num_messages / $context.num_messages) * 100).toFixed(2) + '% of all messages sent.').removeClass('hidden');
  };


  function buildDistributionOverTimeGraph() {

    var raw_data = JSON.parse(document.getElementById('daysByUser').innerHTML);

    var data = []
    var minDate = moment();
    var maxDate = moment("1995-12-25");

    _.each(Object.keys(raw_data), function(d) {
      data.push({
        name: d,
        dates: _.map(raw_data[d], function (d) {
          var msgDate = moment(d);

          // determine the starting date
          if(minDate.isAfter(d)) {
            minDate = msgDate;
          }

          if(maxDate.isBefore(d)) {
            maxDate = msgDate;
          }

          return msgDate;
        })
      });
    });

    var color = getColorScale();

    var eventDropsChart = d3.chart.eventDrops()
      .margin({top: 70, left: 140, bottom: 20, right: 50})
      .width(defaultConfig.largeGraphWidth)
      .start(minDate)
      .end(maxDate)
      .eventHover(function(el){
        console.log(d3.select(el).data());
        console.log(d3.select(el).data()[0].format('YYYY-MM-DDT'));
      })
      .eventLineColor(function (datum, index) {
          return color(index);
      });

    d3.select('#distributionOverTimeSvg')
      .datum(data)
      .call(eventDropsChart);
  };


  function buildCalendarViewGraph() {

    var width = 960,
    height = 136,
    cellSize = 17; // cell size

    var day = d3.time.format("%w"),
      week = d3.time.format("%U"),
      percent = d3.format(".1%"),
      format = d3.time.format("%Y-%m-%d");

    var color = d3.scale.quantize()
      .domain([-.05, .05])
      .range(d3.range(11).map(function(d) { return "q" + d + "-11"; }));

    var svg = d3.select("#calendarViewSvg").selectAll("svg")
      .data(d3.range(1990, 2011))
    .enter().append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("class", "RdYlGn")
    .append("g")
      .attr("transform", "translate(" + ((width - cellSize * 53) / 2) + "," + (height - cellSize * 7 - 1) + ")");

    svg.append("text")
      .attr("transform", "translate(-6," + cellSize * 3.5 + ")rotate(-90)")
      .style("text-anchor", "middle")
      .text(function(d) { return d; });

    var rect = svg.selectAll(".day")
      .data(function(d) { return d3.time.days(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
    .enter().append("rect")
      .attr("class", "day")
      .attr("width", cellSize)
      .attr("height", cellSize)
      .attr("x", function(d) { return week(d) * cellSize; })
      .attr("y", function(d) { return day(d) * cellSize; })
      .datum(format);
    
    rect.append("title")
      .text(function(d) { return d; });

    svg.selectAll(".month")
      .data(function(d) { return d3.time.months(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
    .enter().append("path")
      .attr("class", "month")
      .attr("d", monthPath);

    var data = JSON.parse(document.getElementById('messagesByDay').innerHTML); 

    function monthPath(t0) {
      var t1 = new Date(t0.getFullYear(), t0.getMonth() + 1, 0),
          d0 = +day(t0), w0 = +week(t0),
          d1 = +day(t1), w1 = +week(t1);
      return "M" + (w0 + 1) * cellSize + "," + d0 * cellSize
          + "H" + w0 * cellSize + "V" + 7 * cellSize
          + "H" + w1 * cellSize + "V" + (d1 + 1) * cellSize
          + "H" + (w1 + 1) * cellSize + "V" + 0
          + "H" + (w0 + 1) * cellSize + "Z";
    };
  };

  function buildWordCloud() {

    var colors = d3.scale.category20();

    var data = JSON.parse(document.getElementById('wordHistogram').innerHTML);
    var maxFrequency = data[0].size;

    var tbodyPopular = $$('#mostPopularWords');
    var tbodyUnpopular = $$('#leastPopularWords');

    for(var i = 0; i < 10; i++) {
      console.log(data[i]);
      tbodyPopular.append("<tr><td>" + (i + 1) + "</td><td>" + data[i].text + "</td><td>" + data[i].size + "</td>");
      tbodyUnpopular.append("<tr><td>" + (i + 1) + "</td><td>" + data[data.length - 1 - i].text + "</td><td>" + data[data.length - 1 - i].size + "</td>");
    }

    d3.layout.cloud().size([1108, 580])
      .words(data)
      .padding(5)
      .rotate(function() { return ~~(Math.random() * 2) * 90; })
      .fontSize(function (d) { return calculateFontSize(d.size, maxFrequency); })
      .on("end", drawCloud)
      .start();

    function calculateFontSize(frequency, max) {
      return (frequency * 240) / max;
    }

    function drawCloud(words) {
      d3.select("#wordCloudSvg").append("svg")
        .attr("width", 1108)
        .attr("height", 600)
        .append("g")
        .attr("transform", "translate(554,300)")
        .selectAll("text")
          .data(words)
        .enter().append("text")
          .style("font-size", function(d) { return d.size + "px"; })
          .style("font-family", "Impact")
          .style("fill", function(d, i) { return colors(i); })
          .attr("text-anchor", "middle")
          .attr("transform", function(d) {
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })
          .text(function(d) { return d.text; });
    }

  };


  function getColorScale() {
    return d3.scale.category10();
    if($len(context.users) === 2) {
      // return d3.scale.ordinal().range(['#ea4b54', "#bdc3c7"]);
      return d3.scale.ordinal().range(['#3498db', "#ea4b54"])
    } else {
      return d3.scale.category10();
    }
  }


  function getSvgAddedTo(id, conf) {
    return d3.select(id).append("svg")
      .attr("width", conf.width + conf.margin.left + conf.margin.right)
      .attr("height", conf.height + conf.margin.top + conf.margin.bottom)
      .append("g")
      .attr("transform", "translate(" + (conf.margin.left + 20) + "," + conf.margin.top + ")");
  };


  function getSimpleAxis(scale, orientation) {
    return d3.svg.axis()
      .scale(scale)
      .orient(orientation);
  };


  function getSvgConf(w, h, vertical, horizontal, bottom_opt, left_opt) {

    if(arguments.length != 4 && arguments.length != 6) {
        throw "Illegal number of arguments. Was expecting 4 or 6, received " + arguments.length + ".";
    }

    var margin = {top: vertical, right: horizontal, bottom: bottom_opt ? bottom_opt : vertical, left: left_opt ? left_opt : horizontal},
    width = w - margin.left - margin.right,
    height = h - margin.top - margin.bottom;

    return {
        margin: margin,
        width: width,
        height: height
    }
};
</script>
    
