$def with (context)

<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">WhatsApp Chat Analyzer</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a></li>
        <li><a href="#">About</a></li>
        <li><a href="/upload">Analyse</a></li>
      </ul>
    </div><!--/.navbar-collapse -->
  </div>
</nav>

<div class="container main-content">
  <div class="row">

    <div class="col-sm-12">
      <div class="page-header">
        <h1>Analysis Results</h1>
      </div>

      <h4>Participants</h4>
      $for name in context.users:
          <span class="label label-primary">$name</span>
      
      <h4>Number of Messages</h4> 
        $context.num_messages

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Overview</h3>
        </div>
        <div class="panel-body">
          <table class="table table-striped">
            <tbody>
              <tr><td>In total, the <strong>$len(context.users)</strong> people in this chat sent <strong>$context.num_messages</strong> messages over <strong>$context.overview['num_days']</strong> days. </td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="row">
        
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Who's the biggest spammer?</h3>
            </div>
            <div class="panel-body">
              <div id="biggestSpammerSvg"></div>
            </div>
            <div class="panel-footer hidden" id="biggestSpammerRes"></div>
          </div>
        </div>
        
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Who's getting the biggest slice?</h3>
            </div>
            <div class="panel-body">
              <div id="biggestSliceSvg"></div>
            </div>
            <div class="panel-footer hidden" id="biggestSliceRes"></div>
          </div>
        </div>
      
      </div>
      

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Distribution Over Time</h3>
        </div>
        <div class="panel-body">
          <div id="distributionOverTimeSvg"></div>
        </div>
      </div>

    </div> <!-- /col-sm-12 -->

  </div>
</div>


<hr>

<div class="container">
  <footer>
    <p>TU Delft - Data Visualization 2014/2015</p>
  </footer>
</div>

<div class="hidden" id="overviewData"></div>
<div class="hidden" id="daysByUser">$context.overview['days_by_user']</div>
<div class="hidden" id="biggestSpammerData">$context.messages_by_user</div>

<script type="text/javascript">
  $$(document).ready(function() {
    buildBiggestSpammerGraph();
    buildBiggestSliceGraph();
    buildDistributionOverTimeGraph();
  });

  function buildBiggestSpammerGraph() {
    var conf = getSvgConf(30, 40, 30, 100);
    var format = d3.format(",.0f");

    var x = d3.scale.linear().range([0, conf.width]);
    var y = d3.scale.ordinal().rangeRoundBands([conf.height, 0], .4);
    var xAxis = getSimpleAxis(x, "top").tickSize(-conf.height);
    var yAxis = getSimpleAxis(y, "left").tickSize(0);

    var color = d3.scale.ordinal().range(["#3498db", "#2ecc71", "#e74c3c", "#95a5a6", "#9b59b6", "#34495e", "#f1c40f"]);

    var svg = getSvgAddedTo("#biggestSpammerSvg", conf);

    var data = JSON.parse(document.getElementById("biggestSpammerData").innerHTML);

    x.domain([0, d3.max(data, function(d) { return d.num_messages; })]);
    y.domain(data.map(function (d) { return d.name; }));

    var bar = svg.selectAll("g.bar")
      .data(data)
      .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) { return "translate(0," + y(d.name) + ")"; });

    bar.append("rect")
        .attr("width", function(d) { return x(d.num_messages); })
        .style("fill", function(d) { return color(d.name)})
        .attr("height", y.rangeBand());

    bar.append("text")
        .attr("class", "value")
        .attr("x", function(d) { return x(d.num_messages); })
        .attr("y", y.rangeBand() / 2)
        .attr("dx", -3)
        .attr("dy", ".35em")
        .attr("text-anchor", "end")
        .text(function(d) { return format(d.num_messages); });

    svg.append("g")
        .attr("class", "x axis")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

    var biggestSpammer = _.max(data, function (d) { return d.num_messages;});
    $$('#biggestSpammerRes').html(biggestSpammer.name + ' is clearly the biggest spammer with ' + biggestSpammer.num_messages + ' messages sent.').removeClass('hidden');

  };

  function buildBiggestSliceGraph() {
    var conf = getSvgConf(30, 40, 30, 100);
    var radius = Math.min(conf.width, conf.height) / 2;

    var color = d3.scale.ordinal().range(["#3498db", "#2ecc71", "#e74c3c", "#95a5a6", "#9b59b6", "#34495e", "#f1c40f"]);

    var arc = d3.svg.arc()
      .outerRadius(radius - 10)
      .innerRadius(0);

    var pie = d3.layout.pie()
      .sort(null)
      .value(function(d) { return d.num_messages; });

    var svg = d3.select("#biggestSliceSvg").append("svg")
      .attr("width", conf.width + conf.margin.left + conf.margin.right)
      .attr("height", conf.height + conf.margin.top + conf.margin.bottom)
      .append("g")
      .attr("transform", "translate(" + (conf.width / 2) + "," + (conf.height / 2) + ")");

    var data = JSON.parse(document.getElementById("biggestSpammerData").innerHTML);

    var g = svg.selectAll(".arc")
      .data(pie(data))
      .enter().append("g")
        .attr("class", "arc");

    g.append("path")
        .attr("d", arc)
        .style("fill", function(d) { return color(d.data.name); });

    g.append("text")
        .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
        .attr("dy", ".35em")
        .style("text-anchor", "middle")
        .text(function(d) { return d.data.name; });

    
  };

  function buildDistributionOverTimeGraph() {

    var raw_data = JSON.parse(document.getElementById('daysByUser').innerHTML);

    var data = []
    var minDate = moment();

    _.each(Object.keys(raw_data), function(d) {
      data.push({
        name: d,
        dates: _.map(raw_data[d], function (d) {
          var msgDate = moment(d);

          // determine the starting date
          if(minDate.isAfter(d)) {
            minDate = msgDate;
          }

          return msgDate;
        })
      });
    });

    var color = d3.scale.ordinal().range(["#3498db", "#2ecc71", "#e74c3c", "#95a5a6", "#9b59b6", "#34495e", "#f1c40f"]);

    var eventDropsChart = d3.chart.eventDrops()
      .width(960)
      .start(minDate)
      .eventHover(function(e){
        // console.log(e);
      })
      .eventLineColor(function (datum, index) {
          return color(index);
      });

    d3.select('#distributionOverTimeSvg')
      .datum(data)
      .call(eventDropsChart);
  };

  function getSvgAddedTo(id, conf) {
    return d3.select(id).append("svg")
      .attr("width", conf.width + conf.margin.left + conf.margin.right)
      .attr("height", conf.height + conf.margin.top + conf.margin.bottom)
      .append("g")
      .attr("transform", "translate(" + (conf.margin.left + 20) + "," + conf.margin.top + ")");
  };

  function getSimpleAxis(scale, orientation) {
    return d3.svg.axis()
      .scale(scale)
      .orient(orientation);
  };

  function getSvgConf(first, second, third_opt, forth_opt) {

    if(arguments.length != 2 && arguments.length != 4) {
        throw "Illegal number of arguments. Was expecting 2 or 4, received " + arguments.length + ".";
    }

    var margin = {top: first, right: second, bottom: third_opt ? third_opt : first, left: forth_opt ? forth_opt : second},
    width = 500 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom;

    return {
        margin: margin,
        width: width,
        height: height
    }
};
</script>
    
